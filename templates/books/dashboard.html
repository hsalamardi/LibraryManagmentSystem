{% extends 'library_users/base.html' %}
{% load static %}
{% load math_filters %}

{% block title %}üìä Library Analytics Dashboard{% endblock %}

{% block body_block %}
<div class="container-fluid py-4" style="background: var(--secondary-50); min-height: 100vh;">
    <!-- Modern Dashboard Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-lg rounded-2xl" style="background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-800) 100%);">
                <div class="card-body p-5 text-white">
                    <div class="d-flex justify-content-between align-items-center flex-wrap">
                        <div>
                            <div class="d-flex align-items-center mb-3">
                                <div class="feature-icon bg-white text-primary rounded-xl me-3" style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-chart-line text-2xl"></i>
                                </div>
                                <div>
                                    <h1 class="text-4xl font-bold mb-1">Analytics Dashboard</h1>
                                    <p class="text-xl opacity-90 mb-0">Real-time library insights and performance metrics</p>
                                </div>
                            </div>
                            <div class="d-flex gap-4 flex-wrap">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-calendar-day me-2"></i>
                                    <span class="font-medium">{{ today|date:"F d, Y" }}</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-clock me-2"></i>
                                    <span class="font-medium">Last updated: {{ last_updated|date:"H:i" }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex gap-2 flex-wrap">
                            <a href="{% url 'books:view_books_list' %}" class="btn btn-warning">
                                <i class="fas fa-book me-2"></i>View Catalog
                            </a>
                            <a href="{% url 'books:manage_borrow_requests' %}" class="btn btn-secondary">
                                <i class="fas fa-tasks me-2"></i>Manage Requests
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Key Performance Indicators -->
    <div class="row g-4 mb-4">
        <div class="col-xl-3 col-lg-6 col-md-6">
            <div class="card border-0 shadow-sm rounded-2xl h-100 transition hover:shadow-lg">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <div class="feature-icon bg-primary text-white rounded-xl me-3" style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-book text-lg"></i>
                                </div>
                                <div>
                                    <h3 class="text-3xl font-bold text-primary mb-0">{{ total_books|default:"0" }}</h3>
                                    <p class="text-sm font-medium text-muted mb-0">Total Books</p>
                                </div>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="badge badge-primary me-2">
                                    <i class="fas fa-arrow-up me-1"></i>+{{ reading_stats.new_books_this_month|default:"0" }}
                                </span>
                                <span class="text-xs text-muted">This month</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-lg-6 col-md-6">
            <div class="card border-0 shadow-sm rounded-2xl h-100 transition hover:shadow-lg">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <div class="feature-icon bg-success text-white rounded-xl me-3" style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-check-circle text-lg"></i>
                                </div>
                                <div>
                                    <h3 class="text-3xl font-bold text-success mb-0">{{ available_books|default:"0" }}</h3>
                                    <p class="text-sm font-medium text-muted mb-0">Available</p>
                                </div>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="badge badge-success me-2">
                                    {{ reading_stats.availability_percentage|default:"0" }}%
                                </span>
                                <span class="text-xs text-muted">Availability rate</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-lg-6 col-md-6">
            <div class="card border-0 shadow-sm rounded-2xl h-100 transition hover:shadow-lg">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <div class="feature-icon bg-warning text-white rounded-xl me-3" style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-book-reader text-lg"></i>
                                </div>
                                <div>
                                    <h3 class="text-3xl font-bold text-warning mb-0">{{ borrowed_books|default:"0" }}</h3>
                                    <p class="text-sm font-medium text-muted mb-0">Borrowed</p>
                                </div>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="badge badge-warning me-2">
                                    <i class="fas fa-arrow-up me-1"></i>+{{ reading_stats.books_borrowed_today|default:"0" }}
                                </span>
                                <span class="text-xs text-muted">Today</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-lg-6 col-md-6">
            <div class="card border-0 shadow-sm rounded-2xl h-100 transition hover:shadow-lg">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <div class="feature-icon bg-error text-white rounded-xl me-3" style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-exclamation-triangle text-lg"></i>
                                </div>
                                <div>
                                    <h3 class="text-3xl font-bold text-error mb-0">{{ reading_stats.overdue_books|default:"0" }}</h3>
                                    <p class="text-sm font-medium text-muted mb-0">Overdue</p>
                                </div>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="badge badge-error me-2">
                                    {{ reading_stats.overdue_percentage|default:"0" }}%
                                </span>
                                <span class="text-xs text-muted">Of borrowed</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Additional Statistics Row -->
    <div class="row g-4 mb-4">
        <div class="col-xl-3 col-lg-6 col-md-6">
            <div class="card border-0 shadow-sm rounded-2xl h-100 transition hover:shadow-lg">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <div class="feature-icon bg-info text-white rounded-xl me-3" style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-users text-lg"></i>
                                </div>
                                <div>
                                    <h3 class="text-3xl font-bold text-info mb-0">{{ reading_stats.active_users_this_month|default:"0" }}</h3>
                                    <p class="text-sm font-medium text-muted mb-0">Active Users</p>
                                </div>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="badge badge-info me-2">
                                    <i class="fas fa-arrow-up me-1"></i>+{{ reading_stats.new_users_this_month|default:"0" }}
                                </span>
                                <span class="text-xs text-muted">New this month</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-lg-6 col-md-6">
            <div class="card border-0 shadow-sm rounded-2xl h-100 transition hover:shadow-lg">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <div class="feature-icon bg-purple text-white rounded-xl me-3" style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: #8b5cf6;">
                                    <i class="fas fa-calendar-week text-lg"></i>
                                </div>
                                <div>
                                    <h3 class="text-3xl font-bold mb-0" style="color: #8b5cf6;">{{ reading_stats.books_borrowed_this_week|default:"0" }}</h3>
                                    <p class="text-sm font-medium text-muted mb-0">This Week</p>
                                </div>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="badge me-2" style="background: #8b5cf6; color: white;">
                                    {{ reading_stats.books_returned_today|default:"0" }} returned
                                </span>
                                <span class="text-xs text-muted">Today</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-lg-6 col-md-6">
            <div class="card border-0 shadow-sm rounded-2xl h-100 transition hover:shadow-lg">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <div class="feature-icon bg-dark text-white rounded-xl me-3" style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-chart-bar text-lg"></i>
                                </div>
                                <div>
                                    <h3 class="text-3xl font-bold text-dark mb-0">{{ reading_stats.books_borrowed_this_month|default:"0" }}</h3>
                                    <p class="text-sm font-medium text-muted mb-0">Monthly Activity</p>
                                </div>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="badge badge-dark me-2">
                                    {{ reading_stats.average_books_per_user|default:"0" }} avg/user
                                </span>
                                <span class="text-xs text-muted">Collection ratio</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-lg-6 col-md-6">
            <div class="card border-0 shadow-sm rounded-2xl h-100 transition hover:shadow-lg">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <div class="feature-icon bg-gradient text-white rounded-xl me-3" style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: linear-gradient(45deg, #ff6b6b, #feca57);">
                                    <i class="fas fa-fire text-lg"></i>
                                </div>
                                <div>
                                    <h3 class="text-3xl font-bold mb-0" style="color: #ff6b6b;">{{ utilization_rate|default:"0" }}%</h3>
                                    <p class="text-sm font-medium text-muted mb-0">Utilization</p>
                                </div>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="badge me-2" style="background: linear-gradient(45deg, #ff6b6b, #feca57); color: white;">
                                    <i class="fas fa-trending-up me-1"></i>Active
                                </span>
                                <span class="text-xs text-muted">Collection usage</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Charts and Analytics Section -->
    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm rounded-2xl h-100">
                <div class="card-header bg-white border-0 p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="font-semibold mb-1">Borrowing Trends</h4>
                            <p class="text-muted mb-0">Monthly borrowing activity over the past year</p>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-ghost btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#">Export Data</a></li>
                                <li><a class="dropdown-item" href="#">View Details</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="card-body p-4">
                    <div class="chart-container" style="position: relative; height: 350px;">
                        <canvas id="borrowingChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm rounded-2xl h-100">
                <div class="card-header bg-white border-0 p-4">
                    <h4 class="font-semibold mb-1">Popular Categories</h4>
                    <p class="text-muted mb-0">Most borrowed book categories</p>
                </div>
                <div class="card-body p-4">
                    <div class="chart-container" style="position: relative; height: 350px;">
                        <canvas id="categoriesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Activity and Tables -->
    <div class="row g-4 mb-4">
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm rounded-2xl h-100">
                <div class="card-header bg-white border-0 p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="font-semibold mb-1">Recent Borrowings</h4>
                            <p class="text-muted mb-0">Latest book borrowing activity</p>
                        </div>
                        <a href="{% url 'books:manage_borrow_requests' %}" class="btn btn-primary btn-sm">
                            View All
                        </a>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 400px;">
                        <table class="table table-hover mb-0">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="border-0 p-3 font-medium text-sm text-muted">BOOK</th>
                                    <th class="border-0 p-3 font-medium text-sm text-muted">BORROWER</th>
                                    <th class="border-0 p-3 font-medium text-sm text-muted">DATE</th>
                                    <th class="border-0 p-3 font-medium text-sm text-muted">STATUS</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for borrow in recent_borrowings|slice:":10" %}
                                <tr class="border-0">
                                    <td class="p-3">
                                        <div class="d-flex align-items-center">
                                            <div class="me-3">
                                                <div class="bg-primary rounded" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                                    <i class="fas fa-book text-white"></i>
                                                </div>
                                            </div>
                                            <div>
                                                <div class="font-medium">{{ borrow.book.title|truncatechars:30 }}</div>
                                                <div class="text-sm text-muted">{{ borrow.book.author|truncatechars:25 }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="p-3">
                                        <div class="font-medium">{{ borrow.borrower.user.get_full_name|default:borrow.borrower.user.username }}</div>
                                        <div class="text-sm text-muted">{{ borrow.borrower.user.email|truncatechars:25 }}</div>
                                    </td>
                                    <td class="p-3">
                                        <div class="font-medium">{{ borrow.borrow_date|date:"M d" }}</div>
                                        <div class="text-sm text-muted">{{ borrow.borrow_date|date:"Y" }}</div>
                                    </td>
                                    <td class="p-3">
                                        {% if borrow.is_returned %}
                                            <span class="badge badge-success">Returned</span>
                                        {% elif borrow.is_overdue %}
                                            <span class="badge badge-error">Overdue</span>
                                        {% else %}
                                            <span class="badge badge-warning">Active</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center p-4 text-muted">
                                        <i class="fas fa-inbox fa-2x mb-2"></i>
                                        <div>No recent borrowings</div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm rounded-2xl h-100">
                <div class="card-header bg-white border-0 p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="font-semibold mb-1">Popular Books</h4>
                            <p class="text-muted mb-0">Most borrowed books this month</p>
                        </div>
                        <a href="{% url 'books:view_books_list' %}" class="btn btn-primary btn-sm">
                            View All
                        </a>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 400px;">
                        <table class="table table-hover mb-0">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="border-0 p-3 font-medium text-sm text-muted">RANK</th>
                                    <th class="border-0 p-3 font-medium text-sm text-muted">BOOK</th>
                                    <th class="border-0 p-3 font-medium text-sm text-muted">BORROWS</th>
                                    <th class="border-0 p-3 font-medium text-sm text-muted">RATING</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for book in popular_books|slice:":10" %}
                                <tr class="border-0">
                                    <td class="p-3">
                                        <div class="d-flex align-items-center justify-content-center" style="width: 30px; height: 30px; background: var(--primary-100); border-radius: 50%; color: var(--primary-600); font-weight: bold;">
                                            {{ forloop.counter }}
                                        </div>
                                    </td>
                                    <td class="p-3">
                                        <div class="d-flex align-items-center">
                                            <div class="me-3">
                                                <div class="bg-success rounded" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                                    <i class="fas fa-star text-white"></i>
                                                </div>
                                            </div>
                                            <div>
                                                <div class="font-medium">{{ book.title|truncatechars:30 }}</div>
                                                <div class="text-sm text-muted">{{ book.author|truncatechars:25 }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="p-3">
                                        <div class="font-bold text-primary">{{ book.borrow_count|default:"0" }}</div>
                                        <div class="text-sm text-muted">times</div>
                                    </td>
                                    <td class="p-3">
                                        <div class="d-flex align-items-center">
                                            <div class="text-warning me-1">
                                                {% for i in "12345"|make_list %}
                                                    {% if forloop.counter <= book.average_rating|default:4 %}
                                                        <i class="fas fa-star"></i>
                                                    {% else %}
                                                        <i class="far fa-star"></i>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                            <span class="text-sm text-muted">({{ book.rating_count|default:"0" }})</span>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center p-4 text-muted">
                                        <i class="fas fa-chart-bar fa-2x mb-2"></i>
                                        <div>No data available</div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js and Dashboard JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</script>
{% endblock %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Borrowing Trends Chart
    const borrowingCtx = document.getElementById('borrowingChart');
    if (borrowingCtx) {
        new Chart(borrowingCtx, {
            type: 'line',
            data: {
                labels: JSON.parse({{ borrowing_months|safe }}),
                datasets: [{
                    label: 'Books Borrowed',
                    data: JSON.parse({{ borrowing_data|safe }}),
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }
    
    // Categories Chart
    const categoriesCtx = document.getElementById('categoriesChart');
    if (categoriesCtx) {
        new Chart(categoriesCtx, {
            type: 'doughnut',
            data: {
                labels: {{ category_labels|safe }},
                datasets: [{
                    data: {{ category_data|safe }},
                    backgroundColor: [
                        'rgb(59, 130, 246)',
                        'rgb(34, 197, 94)',
                        'rgb(251, 191, 36)',
                        'rgb(239, 68, 68)',
                        'rgb(168, 85, 247)'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    }
                }
            }
        });
    }
});
</script>

<!-- Enhanced Dashboard Styles -->
<style>
.card {
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
}

.table-hover tbody tr:hover {



        </div>
    </div>
    
    <!-- Public Library Information Section -->
    {% if is_public_dashboard %}
    <div class="container mb-5">
        <div class="row">
            <!-- Library Services -->
            <div class="col-lg-4 mb-4">
                <div class="dashboard-card h-100">
                    <h4 class="text-primary mb-3"><i class="fas fa-concierge-bell me-2"></i>Our Services</h4>
                    <ul class="list-unstyled">
                        {% for service in library_info.services %}
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>{{ service }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            
            <!-- Opening Hours & Contact -->
            <div class="col-lg-4 mb-4">
                <div class="dashboard-card h-100">
                    <h4 class="text-primary mb-3"><i class="fas fa-clock me-2"></i>Visit Us</h4>
                    <div class="mb-3">
                        <h6 class="fw-bold">Opening Hours</h6>
                        <p class="mb-1"><strong>Mon-Fri:</strong> {{ library_info.opening_hours.monday_friday }}</p>
                        <p class="mb-1"><strong>Saturday:</strong> {{ library_info.opening_hours.saturday }}</p>
                        <p class="mb-3"><strong>Sunday:</strong> {{ library_info.opening_hours.sunday }}</p>
                    </div>
                    <div>
                        <h6 class="fw-bold">Contact Information</h6>
                        <p class="mb-1"><i class="fas fa-phone text-primary me-2"></i>{{ library_info.contact.phone }}</p>
                        <p class="mb-1"><i class="fas fa-envelope text-primary me-2"></i>{{ library_info.contact.email }}</p>
                        <p class="mb-0"><i class="fas fa-map-marker-alt text-primary me-2"></i>{{ library_info.contact.address }}</p>
                    </div>
                </div>
            </div>
            
            <!-- Today's Activity -->
            <div class="col-lg-4 mb-4">
                <div class="dashboard-card h-100">
                    <h4 class="text-primary mb-3"><i class="fas fa-calendar-day me-2"></i>Today's Activity</h4>
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="bg-light rounded p-3">
                                <h3 class="text-success mb-1">{{ reading_stats.books_borrowed_today }}</h3>
                                <small class="text-muted">Books Borrowed</small>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="bg-light rounded p-3">
                                <h3 class="text-info mb-1">{{ reading_stats.books_returned_today }}</h3>
                                <small class="text-muted">Books Returned</small>
                            </div>
                        </div>
                    </div>
                    <div class="text-center">
                        <p class="mb-1"><strong>Most Active Day:</strong> {{ reading_stats.most_active_day }}</p>
                        <p class="mb-0"><strong>Avg Books/User:</strong> {{ reading_stats.average_books_per_user }}</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Popular Books Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="dashboard-card">
                    <h4 class="text-primary mb-4"><i class="fas fa-star me-2"></i>Most Popular Books</h4>
                    <div class="row">
                        {% for book in popular_books|slice:":6" %}
                        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                            <div class="text-center p-3 bg-light rounded">
                                <div class="mb-2">
                                    {% if book.cover_image %}
                                        <img src="{{ book.cover_image.url }}" alt="{{ book.title }}" class="img-fluid" style="height: 120px; object-fit: cover;">
                                    {% else %}
                                        <div class="bg-primary text-white d-flex align-items-center justify-content-center" style="height: 120px; width: 80px; margin: 0 auto;">
                                            <i class="fas fa-book fa-2x"></i>
                                        </div>
                                    {% endif %}
                                </div>
                                <h6 class="small fw-bold mb-1">{{ book.title|truncatechars:30 }}</h6>
                                <small class="text-muted">{{ book.author|truncatechars:25 }}</small>
                                <div class="mt-2">
                                    <span class="badge bg-success">{{ book.borrow_count }} borrows</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Additions -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="dashboard-card">
                    <h4 class="text-primary mb-4"><i class="fas fa-plus-circle me-2"></i>Recently Added Books</h4>
                    <div class="row">
                        {% for book in recent_books|slice:":6" %}
                        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                            <div class="text-center p-3 bg-light rounded">
                                <div class="mb-2">
                                    {% if book.cover_image %}
                                        <img src="{{ book.cover_image.url }}" alt="{{ book.title }}" class="img-fluid" style="height: 120px; object-fit: cover;">
                                    {% else %}
                                        <div class="bg-info text-white d-flex align-items-center justify-content-center" style="height: 120px; width: 80px; margin: 0 auto;">
                                            <i class="fas fa-book fa-2x"></i>
                                        </div>
                                    {% endif %}
                                </div>
                                <h6 class="small fw-bold mb-1">{{ book.title|truncatechars:30 }}</h6>
                                <small class="text-muted">{{ book.author|truncatechars:25 }}</small>
                                <div class="mt-2">
                                    <span class="badge bg-info">New</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
         
         <!-- Collection Overview -->
         <div class="row mb-4">
             <div class="col-lg-6 mb-4">
                 <div class="dashboard-card h-100">
                     <h4 class="text-primary mb-4"><i class="fas fa-globe me-2"></i>Collection by Language</h4>
                     <div class="row">
                         {% for lang_stat in language_stats %}
                         <div class="col-12 mb-3">
                             <div class="d-flex justify-content-between align-items-center">
                                 <span class="fw-bold">{{ lang_stat.language|default:"Unknown" }}</span>
                                 <span class="badge bg-primary">{{ lang_stat.count }} books</span>
                             </div>
                             <div class="progress mt-1" style="height: 8px;">
                                 <div class="progress-bar bg-primary" style="width: {{ lang_stat.count|percentage:total_books }}%"></div>
                             </div>
                         </div>
                         {% endfor %}
                     </div>
                 </div>
             </div>
             
             <div class="col-lg-6 mb-4">
                 <div class="dashboard-card h-100">
                     <h4 class="text-primary mb-4"><i class="fas fa-tags me-2"></i>Popular Categories</h4>
                     <div class="row">
                         {% for cat_stat in category_stats %}
                         <div class="col-12 mb-3">
                             <div class="d-flex justify-content-between align-items-center">
                                 <span class="fw-bold">{{ cat_stat.main_class|default:"General" }}</span>
                                 <span class="badge bg-success">{{ cat_stat.count }} books</span>
                             </div>
                             <div class="progress mt-1" style="height: 8px;">
                                 <div class="progress-bar bg-success" style="width: {{ cat_stat.count|percentage:total_books }}%"></div>
                             </div>
                         </div>
                         {% endfor %}
                     </div>
                 </div>
             </div>
         </div>
         
         <!-- Quick Access Actions -->
         <div class="row mb-4">
             <div class="col-12">
                 <div class="dashboard-card">
                     <h4 class="text-primary mb-4"><i class="fas fa-rocket me-2"></i>Quick Access</h4>
                     <div class="row text-center">
                         <div class="col-lg-3 col-md-6 mb-3">
                             <a href="{% url 'books:view_books_list' %}" class="btn btn-outline-primary btn-lg w-100 py-3">
                                 <i class="fas fa-search d-block mb-2 fa-2x"></i>
                                 <strong>Browse Books</strong>
                                 <small class="d-block text-muted">Explore our collection</small>
                             </a>
                         </div>
                         <div class="col-lg-3 col-md-6 mb-3">
                             <a href="{% url 'books:search_results' %}" class="btn btn-outline-success btn-lg w-100 py-3">
                                 <i class="fas fa-book-reader d-block mb-2 fa-2x"></i>
                                 <strong>Search Books</strong>
                                 <small class="d-block text-muted">Find specific titles</small>
                             </a>
                         </div>
                         <div class="col-lg-3 col-md-6 mb-3">
                             <a href="{% url 'library_users:register' %}" class="btn btn-outline-info btn-lg w-100 py-3">
                                 <i class="fas fa-user-plus d-block mb-2 fa-2x"></i>
                                 <strong>Join Library</strong>
                                 <small class="d-block text-muted">Become a member</small>
                             </a>
                         </div>
                         <div class="col-lg-3 col-md-6 mb-3">
                             <a href="{% url 'library_users:login' %}" class="btn btn-outline-warning btn-lg w-100 py-3">
                                 <i class="fas fa-sign-in-alt d-block mb-2 fa-2x"></i>
                                 <strong>Member Login</strong>
                                 <small class="d-block text-muted">Access your account</small>
                             </a>
                         </div>
                     </div>
                 </div>
             </div>
         </div>
     </div>
      {% endif %}
      
      <!-- Public Library Statistics -->
      {% if is_public_dashboard %}
      <div class="container mb-5">
          <div class="row mb-4">
              <div class="col-12">
                  <h2 class="section-title">üìä Library at a Glance</h2>
              </div>
          </div>
          
          <div class="metric-grid">
              <!-- Total Collection -->
              <div class="stat-card primary">
                  <div class="stat-icon"><i class="fas fa-books"></i></div>
                  <div class="stat-number">{{ total_books|default:0 }}</div>
                  <div class="stat-label">Total Books</div>
                  <div class="stat-description">Complete collection size</div>
              </div>
              
              <!-- Available Books -->
              <div class="stat-card success">
                  <div class="stat-icon"><i class="fas fa-book-open"></i></div>
                  <div class="stat-number">{{ available_books|default:0 }}</div>
                  <div class="stat-label">Available Now</div>
                  <div class="stat-description">Ready to borrow</div>
              </div>
              
              <!-- Community Members -->
              <div class="stat-card info">
                  <div class="stat-icon"><i class="fas fa-users"></i></div>
                  <div class="stat-number">{{ total_users|default:0 }}</div>
                  <div class="stat-label">Community Members</div>
                  <div class="stat-description">Registered readers</div>
              </div>
              
              <!-- Collection Utilization -->
              <div class="stat-card warning">
                  <div class="stat-icon"><i class="fas fa-chart-pie"></i></div>
                  <div class="stat-number">{{ utilization_rate|default:0 }}%</div>
                  <div class="stat-label">Collection Usage</div>
                  <div class="stat-description">Books currently in use</div>
              </div>
          </div>
      </div>
      {% endif %}
  
      <div class="container">
         <!-- Key Performance Indicators -->
         {% if not is_public_dashboard %}
         <div class="row mb-4">
             <div class="col-12">
                 <h2 class="section-title">üìà Key Performance Indicators</h2>
             </div>
         </div>
        
        <div class="metric-grid">
            <!-- Total Books -->
            <div class="stat-card primary">
                <div class="stat-icon"><i class="fas fa-books"></i></div>
                <div class="stat-number">{{ book_stats.total_books|default:0 }}</div>
                <div class="stat-label">Total Books</div>
                <div class="stat-change">üìö Collection Size</div>
            </div>
            
            <!-- Available Books -->
            <div class="stat-card success">
                <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                <div class="stat-number">{{ book_stats.available_books|default:0 }}</div>
                <div class="stat-label">Available Books</div>
                <div class="stat-change">‚úÖ Ready to Borrow</div>
            </div>
            
            <!-- Active Users -->
            <div class="stat-card info">
                <div class="stat-icon"><i class="fas fa-users"></i></div>
                <div class="stat-number">{{ user_stats.active_users|default:0 }}</div>
                <div class="stat-label">Active Users</div>
                <div class="stat-change">üë• Library Members</div>
            </div>
            
            <!-- Active Borrowings -->
            <div class="stat-card warning">
                <div class="stat-icon"><i class="fas fa-hand-holding"></i></div>
                <div class="stat-number">{{ borrowing_stats.active_borrowings|default:0 }}</div>
                <div class="stat-label">Active Borrowings</div>
                <div class="stat-change">üìñ Currently Borrowed</div>
            </div>
            
            <!-- Pending Requests -->
            <div class="stat-card danger">
                <div class="stat-icon"><i class="fas fa-clock"></i></div>
                <div class="stat-number">{{ request_stats.total_pending_requests|default:0 }}</div>
                <div class="stat-label">Pending Requests</div>
                <div class="stat-change">‚è≥ Awaiting Action</div>
            </div>
            
            <!-- Collection Utilization -->
            <div class="stat-card dark">
                <div class="stat-icon"><i class="fas fa-chart-pie"></i></div>
                <div class="stat-number">{{ system_health.collection_utilization_rate|default:0 }}%</div>
                <div class="stat-label">Utilization Rate</div>
                <div class="stat-change">üìä Collection Usage</div>
            </div>
        </div>

        <!-- Financial & Request Management -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="dashboard-card">
                    <h5 class="section-title">üí∞ Financial Overview</h5>
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center p-3">
                                <h3 class="text-success">${{ financial_stats.total_fines_collected|default:0 }}</h3>
                                <small class="text-muted">Total Fines Collected</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-3">
                                <h3 class="text-warning">${{ financial_stats.outstanding_fines|default:0 }}</h3>
                                <small class="text-muted">Outstanding Fines</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-3">
                                <h3 class="text-info">${{ financial_stats.monthly_fines|default:0 }}</h3>
                                <small class="text-muted">This Month</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-3">
                                <h3 class="text-primary">{{ financial_stats.users_with_fines|default:0 }}</h3>
                                <small class="text-muted">Users with Fines</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="dashboard-card">
                    <h5 class="section-title">üìã Request Management</h5>
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center p-3">
                                <h3 class="text-primary">{{ request_stats.pending_borrow_requests|default:0 }}</h3>
                                <small class="text-muted">Pending Borrow</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-3">
                                <h3 class="text-warning">{{ request_stats.pending_return_requests|default:0 }}</h3>
                                <small class="text-muted">Pending Return</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-3">
                                <h3 class="text-success">{{ request_stats.recent_borrow_requests|default:0 }}</h3>
                                <small class="text-muted">Recent Borrow (7d)</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-3">
                                <h3 class="text-info">{{ request_stats.recent_return_requests|default:0 }}</h3>
                                <small class="text-muted">Recent Return (7d)</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Health & Activity -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="dashboard-card">
                    <h5 class="section-title">üè• System Health</h5>
                    <div class="text-center mb-3">
                        <div class="progress-ring">
                            <svg class="progress-ring">
                                <circle class="progress-ring-circle"></circle>
                                <circle class="progress-ring-progress" style="stroke-dashoffset: {% widthratio system_health.collection_utilization_rate|default:0 100 326.73 as offset %}{{ 326.73|subtract:offset }}"></circle>
                            </svg>
                            <div class="position-absolute top-50 start-50 translate-middle">
                                <h4>{{ system_health.collection_utilization_rate|default:0 }}%</h4>
                                <small>Utilization</small>
                            </div>
                        </div>
                    </div>
                    <div class="row text-center">
                        <div class="col-6">
                            <strong>{{ system_health.books_never_borrowed|default:0 }}</strong>
                            <br><small class="text-muted">Never Borrowed</small>
                        </div>
                        <div class="col-6">
                            <strong>{{ system_health.avg_books_per_user|default:0 }}</strong>
                            <br><small class="text-muted">Avg Books/User</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="dashboard-card">
                    <h5 class="section-title">üìä Today's Activity</h5>
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                            <span><i class="fas fa-user-plus text-success me-2"></i>New Users</span>
                            <span class="badge bg-success rounded-pill">{{ system_health.daily_activity.new_users_today|default:0 }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                            <span><i class="fas fa-download text-primary me-2"></i>Books Borrowed</span>
                            <span class="badge bg-primary rounded-pill">{{ system_health.daily_activity.books_borrowed_today|default:0 }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                            <span><i class="fas fa-upload text-info me-2"></i>Books Returned</span>
                            <span class="badge bg-info rounded-pill">{{ system_health.daily_activity.books_returned_today|default:0 }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                            <span><i class="fas fa-paper-plane text-warning me-2"></i>Requests Submitted</span>
                            <span class="badge bg-warning rounded-pill">{{ system_health.daily_activity.requests_submitted_today|default:0 }}</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="dashboard-card">
                    <h5 class="section-title">üìà Weekly Trends</h5>
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                            <span><i class="fas fa-users text-success me-2"></i>New Members</span>
                            <span class="badge bg-success rounded-pill">{{ system_health.weekly_activity.new_users_week|default:0 }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                            <span><i class="fas fa-book text-primary me-2"></i>Books Borrowed</span>
                            <span class="badge bg-primary rounded-pill">{{ system_health.weekly_activity.books_borrowed_week|default:0 }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                            <span><i class="fas fa-undo text-info me-2"></i>Books Returned</span>
                            <span class="badge bg-info rounded-pill">{{ system_health.weekly_activity.books_returned_week|default:0 }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                            <span><i class="fas fa-chart-line text-warning me-2"></i>Avg Borrow Days</span>
                            <span class="badge bg-warning rounded-pill">{{ borrowing_stats.avg_borrowing_days|default:0 }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Charts Section -->
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="section-title">üìä Reading Analytics & Insights</h2>
            </div>
        </div>
        
        <!-- Primary Charts Row -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="dashboard-card">
                    <h5 class="section-title">üìà Monthly Reading Trends (12 Months)</h5>
                    <div class="chart-container">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="dashboard-card">
                    <h5 class="section-title">üåç Collection by Language</h5>
                    <div class="chart-container">
                        <canvas id="languageChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Secondary Charts Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="dashboard-card">
                    <h5 class="section-title">üìö Popular Categories</h5>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="dashboard-card">
                    <h5 class="section-title">‚úçÔ∏è Top Authors</h5>
                    <div class="chart-container">
                        <canvas id="authorsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Engagement Metrics Row -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="dashboard-card">
                    <h5 class="section-title">üë• User Engagement</h5>
                    <div class="text-center">
                        <div class="progress-ring mb-3">
                            <svg class="progress-ring">
                                <circle class="progress-ring-circle"></circle>
                                <circle class="progress-ring-progress" style="stroke-dashoffset: {% widthratio chart_data.engagement_rate 100 326.73 as offset %}{{ 326.73|subtract:offset }}"></circle>
                            </svg>
                            <div class="position-absolute top-50 start-50 translate-middle">
                                <h4>{{ chart_data.engagement_rate }}%</h4>
                                <small>Engaged</small>
                            </div>
                        </div>
                        <p class="text-muted">{{ chart_data.active_readers }} of {{ user_stats.active_users }} users currently reading</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="dashboard-card">
                    <h5 class="section-title">‚úÖ Completion Rate</h5>
                    <div class="text-center">
                        <div class="progress-ring mb-3">
                            <svg class="progress-ring">
                                <circle class="progress-ring-circle"></circle>
                                <circle class="progress-ring-progress" style="stroke-dashoffset: {% widthratio chart_data.completion_rate 100 326.73 as offset %}{{ 326.73|subtract:offset }}; stroke: #28a745;"></circle>
                            </svg>
                            <div class="position-absolute top-50 start-50 translate-middle">
                                <h4>{{ chart_data.completion_rate }}%</h4>
                                <small>Completed</small>
                            </div>
                        </div>
                        <p class="text-muted">Books successfully returned on time</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="dashboard-card">
                    <h5 class="section-title">üìä Weekly Activity</h5>
                    <div class="chart-container" style="height: 200px;">
                        <canvas id="weeklyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Additional Analytics Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="dashboard-card">
                    <h5 class="section-title">üìñ Book Conditions</h5>
                    <div class="chart-container">
                        <canvas id="conditionsChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="dashboard-card">
                    <h5 class="section-title">üìà Reading Trends (6 Months)</h5>
                    <div class="chart-container">
                        <canvas id="trendsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Tables Row -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="dashboard-card">
                    <h5 class="section-title">üìö Popular Books</h5>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Borrows</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for book in popular_books %}
                                <tr>
                                    <td>
                                        <a href="{% url 'books:book_detail' book.pk %}" class="text-decoration-none">
                                            {{ book.title|truncatechars:25 }}
                                        </a>
                                        <br><small class="text-muted">{{ book.author|truncatechars:20 }}</small>
                                    </td>
                                    <td><span class="badge bg-primary">{{ book.borrow_count }}</span></td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="2" class="text-muted text-center">No borrowing data available</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="dashboard-card">
                    <h5 class="section-title">‚ö†Ô∏è Overdue Books</h5>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Book</th>
                                    <th>Days Overdue</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for borrowing in overdue_books %}
                                <tr>
                                    <td>
                                        <a href="{% url 'books:book_detail' borrowing.book.pk %}" class="text-decoration-none">
                                            {{ borrowing.book.title|truncatechars:20 }}
                                        </a>
                                        <br><small class="text-muted">{{ borrowing.borrower.user.get_full_name|truncatechars:15 }}</small>
                                    </td>
                                    <td><span class="badge bg-danger overdue">{{ borrowing.days_overdue|default:"N/A" }}</span></td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="2" class="text-success text-center">No overdue books! üéâ</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="dashboard-card">
                    <h5 class="section-title">üèÜ Top Performers</h5>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Books</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in top_performers.top_borrowers %}
                                <tr>
                                    <td>
                                        <strong>{{ user.user.get_full_name|default:user.user.username|truncatechars:20 }}</strong>
                                        <br><small class="text-muted">{{ user.get_user_type_display }}</small>
                                    </td>
                                    <td><span class="badge bg-success">{{ user.total_borrowed }}</span></td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="2" class="text-muted text-center">No data available</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Books Due Soon -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="dashboard-card">
                    <h5 class="section-title">üìÖ Books Due Soon (Next 3 Days)</h5>
                    {% if books_due_soon %}
                        <div class="alert alert-custom alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>{{ books_due_soon|length }} book{{ books_due_soon|length|pluralize }} due soon!</strong>
                            Consider sending reminders to borrowers.
                        </div>
                    {% endif %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Book</th>
                                    <th>Borrower</th>
                                    <th>Due Date</th>
                                    <th>Contact</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for borrowing in books_due_soon %}
                                <tr>
                                    <td>
                                        <a href="{% url 'books:book_detail' borrowing.book.pk %}" class="text-decoration-none">
                                            <strong>{{ borrowing.book.title|truncatechars:30 }}</strong>
                                        </a>
                                        <br><small class="text-muted">{{ borrowing.book.author|truncatechars:25 }}</small>
                                    </td>
                                    <td>
                                        <strong>{{ borrowing.borrower.user.get_full_name|default:borrowing.borrower.user.username }}</strong>
                                        <br><small class="text-muted">{{ borrowing.borrower.get_user_type_display }}</small>
                                    </td>
                                    <td>
                                        <span class="badge badge-custom bg-warning due-soon">{{ borrowing.due_date }}</span>
                                        <br><small class="text-muted">{{ borrowing.due_date|timeuntil }}</small>
                                    </td>
                                    <td>
                                        <a href="mailto:{{ borrowing.borrower.user.email }}" class="text-decoration-none">
                                            {{ borrowing.borrower.user.email|truncatechars:25 }}
                                        </a>
                                        {% if borrowing.borrower.phone_number %}
                                            <br><small class="text-muted">{{ borrowing.borrower.phone_number }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="sendReminder({{ borrowing.id }})">
                                            <i class="fas fa-envelope me-1"></i>Remind
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center text-success py-4">
                                        <i class="fas fa-check-circle fa-2x mb-2"></i>
                                        <br>No books due soon! All borrowers are on track. üéâ
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="dashboard-card">
                    <h5 class="section-title">üöÄ Quick Actions</h5>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <a href="{% url 'books:add_a_book' %}" class="quick-action-btn w-100 d-block text-center">
                                <i class="fas fa-plus-circle d-block mb-2" style="font-size: 2rem;"></i>
                                Add New Book
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="{% url 'books:view_books_list' %}" class="quick-action-btn w-100 d-block text-center">
                                <i class="fas fa-books d-block mb-2" style="font-size: 2rem;"></i>
                                Browse Books
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="{% url 'books:manage_borrow_requests' %}" class="quick-action-btn w-100 d-block text-center">
                                <i class="fas fa-tasks d-block mb-2" style="font-size: 2rem;"></i>
                                Manage Requests
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="{% url 'books:reports' %}" class="quick-action-btn w-100 d-block text-center">
                                <i class="fas fa-chart-bar d-block mb-2" style="font-size: 2rem;"></i>
                                View Reports
                            </a>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <button class="quick-action-btn w-100 d-block text-center" onclick="generateReport()">
                                <i class="fas fa-file-export d-block mb-2" style="font-size: 2rem;"></i>
                                Generate Report
                            </button>
                        </div>
                        <div class="col-md-3 mb-3">
                            <button class="quick-action-btn w-100 d-block text-center" onclick="exportData()">
                                <i class="fas fa-download d-block mb-2" style="font-size: 2rem;"></i>
                                Export Data
                            </button>
                        </div>
                        <div class="col-md-3 mb-3">
                            <button class="quick-action-btn w-100 d-block text-center" onclick="refreshDashboard()">
                                <i class="fas fa-sync-alt d-block mb-2" style="font-size: 2rem;"></i>
                                Refresh Data
                            </button>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="{% url 'books:barcode_scan' %}" class="quick-action-btn w-100 d-block text-center">
                                <i class="fas fa-barcode d-block mb-2" style="font-size: 2rem;"></i>
                                Barcode Scanner
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
// Chart.js default configuration
Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
Chart.defaults.color = '#666';

// Enhanced Monthly Trends Chart
const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
const monthlyChart = new Chart(monthlyCtx, {
    type: 'line',
    data: {
        labels: JSON.parse({{ chart_data.monthly_borrowings|safe }}).map(item => item.month),
        datasets: [{
            label: 'Borrowings',
            data: JSON.parse({{ chart_data.monthly_borrowings|safe }}).map(item => item.borrowings),
            borderColor: 'rgb(102, 126, 234)',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            tension: 0.4,
            fill: true,
            pointBackgroundColor: 'rgb(102, 126, 234)',
            pointBorderColor: '#fff',
            pointBorderWidth: 3,
            pointRadius: 6
        }, {
            label: 'Returns',
            data: JSON.parse({{ chart_data.monthly_borrowings|safe }}).map(item => item.returns),
            borderColor: 'rgb(40, 167, 69)',
            backgroundColor: 'rgba(40, 167, 69, 0.1)',
            tension: 0.4,
            fill: true,
            pointBackgroundColor: 'rgb(40, 167, 69)',
            pointBorderColor: '#fff',
            pointBorderWidth: 3,
            pointRadius: 6
        }, {
            label: 'New Users',
            data: JSON.parse({{ chart_data.monthly_borrowings|safe }}).map(item => item.new_users || 0),
            borderColor: 'rgb(255, 193, 7)',
            backgroundColor: 'rgba(255, 193, 7, 0.1)',
            tension: 0.4,
            fill: false,
            pointBackgroundColor: 'rgb(255, 193, 7)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4
        }, {
            label: 'New Books',
            data: JSON.parse({{ chart_data.monthly_borrowings|safe }}).map(item => item.new_books || 0),
            borderColor: 'rgb(220, 53, 69)',
            backgroundColor: 'rgba(220, 53, 69, 0.1)',
            tension: 0.4,
            fill: false,
            pointBackgroundColor: 'rgb(220, 53, 69)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
                labels: {
                    usePointStyle: true,
                    padding: 15,
                    font: {
                        size: 12
                    }
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0,0,0,0.8)',
                titleColor: 'white',
                bodyColor: 'white',
                borderColor: 'rgba(102, 126, 234, 0.8)',
                borderWidth: 1,
                cornerRadius: 8
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0,0,0,0.1)'
                },
                ticks: {
                    font: {
                        size: 11
                    }
                }
            },
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    font: {
                        size: 11
                    }
                }
            }
        },
        interaction: {
            intersect: false,
            mode: 'index'
        }
    }
});

// Collection Distribution Chart
const languageCtx = document.getElementById('languageChart').getContext('2d');
const languageChart = new Chart(languageCtx, {
    type: 'doughnut',
    data: {
        labels: JSON.parse({{ chart_data.books_by_language|safe }}).map(item => item.language),
        datasets: [{
            data: JSON.parse({{ chart_data.books_by_language|safe }}).map(item => item.count),
            backgroundColor: [
                '#667eea',
                '#764ba2', 
                '#f093fb',
                '#f5576c',
                '#4facfe',
                '#00f2fe',
                '#43e97b',
                '#38f9d7'
            ],
            borderWidth: 0,
            hoverOffset: 10
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 20,
                    usePointStyle: true
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0,0,0,0.8)',
                titleColor: 'white',
                bodyColor: 'white'
            }
        },
        cutout: '60%'
    }
});

// Popular Categories Chart
 const categoryCtx = document.getElementById('categoryChart').getContext('2d');
 const categoryChart = new Chart(categoryCtx, {
     type: 'bar',
     data: {
         labels: JSON.parse({{ chart_data.books_by_category|safe }}).map(item => item.main_class || 'Unknown'),
         datasets: [{
             label: 'Books',
             data: JSON.parse({{ chart_data.books_by_category|safe }}).map(item => item.count),
            backgroundColor: 'rgba(102, 126, 234, 0.8)',
            borderColor: 'rgb(102, 126, 234)',
            borderWidth: 1,
            borderRadius: 5
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                 display: false
            },
            tooltip: {
                backgroundColor: 'rgba(0,0,0,0.8)',
                titleColor: 'white',
                bodyColor: 'white'
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0,0,0,0.1)'
                }
            },
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    maxRotation: 45
                }
            }
        }
    }
});

// Top Authors Chart
 const authorsCtx = document.getElementById('authorsChart').getContext('2d');
 const authorsChart = new Chart(authorsCtx, {
     type: 'bar',
     data: {
         labels: JSON.parse({{ chart_data.popular_authors|safe }}).map(item => item.author || 'Unknown'),
         datasets: [{
             label: 'Borrowed Books',
             data: JSON.parse({{ chart_data.popular_authors|safe }}).map(item => item.borrow_count),
            backgroundColor: 'rgba(40, 167, 69, 0.8)',
            borderColor: 'rgb(40, 167, 69)',
            borderWidth: 1
        }]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: 'rgba(0,0,0,0.8)',
                titleColor: 'white',
                bodyColor: 'white'
            }
        },
        scales: {
            x: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0,0,0,0.1)'
                }
            },
            y: {
                grid: {
                    display: false
                }
            }
        }
    }
});

// Weekly Activity Chart
 const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
 const weeklyChart = new Chart(weeklyCtx, {
     type: 'bar',
     data: {
         labels: JSON.parse({{ chart_data.weekly_activity|safe }}).map(item => item.week),
         datasets: [{
             label: 'Borrowings',
             data: JSON.parse({{ chart_data.weekly_activity|safe }}).map(item => item.borrowings),
            backgroundColor: [
                'rgba(102, 126, 234, 0.8)',
                'rgba(40, 167, 69, 0.8)',
                'rgba(255, 193, 7, 0.8)',
                'rgba(220, 53, 69, 0.8)',
                'rgba(23, 162, 184, 0.8)',
                'rgba(108, 117, 125, 0.8)',
                'rgba(111, 66, 193, 0.8)'
            ],
            borderWidth: 0,
            borderRadius: 3
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                display: false
            },
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    font: {
                        size: 10
                    }
                }
            }
        }
    }
});

// Book Conditions Chart
 const conditionsCtx = document.getElementById('conditionsChart').getContext('2d');
 const conditionsChart = new Chart(conditionsCtx, {
     type: 'pie',
     data: {
         labels: JSON.parse({{ chart_data.book_conditions|safe }}).map(item => item.condition || 'Unknown'),
         datasets: [{
             data: JSON.parse({{ chart_data.book_conditions|safe }}).map(item => item.count),
            backgroundColor: [
                '#28a745',
                '#ffc107',
                '#fd7e14',
                '#dc3545'
            ],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 15,
                    usePointStyle: true
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0,0,0,0.8)',
                titleColor: 'white',
                bodyColor: 'white'
            }
        }
    }
});

// Reading Trends Chart (6 months)
 const trendsCtx = document.getElementById('trendsChart').getContext('2d');
 const trendsChart = new Chart(trendsCtx, {
     type: 'line',
     data: {
         labels: JSON.parse({{ chart_data.reading_trends|safe }}).map(item => item.month),
         datasets: [{
             label: 'Books Borrowed',
             data: JSON.parse({{ chart_data.reading_trends|safe }}).map(item => item.count),
            borderColor: 'rgb(102, 126, 234)',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            tension: 0.4,
            fill: true,
            pointBackgroundColor: 'rgb(102, 126, 234)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 5
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: 'rgba(0,0,0,0.8)',
                titleColor: 'white',
                bodyColor: 'white'
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0,0,0,0.1)'
                }
            },
            x: {
                grid: {
                    display: false
                }
            }
        }
    }
});

// Enhanced JavaScript functions
function sendReminder(borrowingId) {
    if (confirm('Send reminder email to borrower?')) {
        // Show loading state
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Sending...';
        btn.disabled = true;
        
        // Simulate API call
        setTimeout(() => {
            btn.innerHTML = '<i class="fas fa-check me-1"></i>Sent!';
            btn.classList.remove('btn-outline-primary');
            btn.classList.add('btn-success');
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-primary');
                btn.disabled = false;
            }, 2000);
        }, 1500);
    }
}

function generateReport() {
    const reportWindow = window.open('/books/reports/', '_blank');
    if (reportWindow) {
        showNotification('Report opened in new tab', 'success');
    } else {
        showNotification('Please allow popups to view reports', 'warning');
    }
}

function exportData() {
    showNotification('Export feature coming soon! üìä', 'info');
}

function refreshDashboard() {
    showNotification('Refreshing dashboard data...', 'info');
    setTimeout(() => {
        location.reload();
    }, 1000);
}

function showNotification(message, type = 'info') {
    const alertClass = {
        'success': 'alert-success',
        'warning': 'alert-warning', 
        'danger': 'alert-danger',
        'info': 'alert-info'
    }[type] || 'alert-info';
    
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

// Real-time updates simulation
function updateRealTimeStats() {
    // Simulate real-time data updates
    const stats = document.querySelectorAll('.stat-number');
    stats.forEach(stat => {
        const currentValue = parseInt(stat.textContent);
        if (Math.random() > 0.8) { // 20% chance of update
            const change = Math.random() > 0.5 ? 1 : -1;
            const newValue = Math.max(0, currentValue + change);
            stat.textContent = newValue;
            
            // Add visual feedback
            stat.style.transform = 'scale(1.1)';
            setTimeout(() => {
                stat.style.transform = 'scale(1)';
            }, 300);
        }
    });
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    // Add loading animation to cards
    const cards = document.querySelectorAll('.dashboard-card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            card.style.transition = 'all 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
    
    // Show welcome notification
    setTimeout(() => {
        showNotification('üìä Dashboard loaded successfully!', 'success');
    }, 1000);
});

// Auto-refresh dashboard every 10 minutes
setInterval(function() {
    updateRealTimeStats();
}, 60000); // Update stats every minute

setInterval(function() {
    showNotification('Auto-refreshing dashboard...', 'info');
    setTimeout(() => location.reload(), 2000);
}, 600000); // Full refresh every 10 minutes
</script>
{% endblock %}