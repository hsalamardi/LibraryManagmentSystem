<!DOCTYPE html>
{% extends 'landing_page.html' %}
{% load static %}

{% block body_block %}
<body>
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h2 class="mb-0"><i class="fas fa-barcode"></i> Barcode Scanner</h2>
                        <p class="mb-0 text-light">Scan or enter a barcode to quickly find and manage books</p>
                    </div>
                    <div class="card-body">
                        <!-- Scanner Controls -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-camera"></i> Camera Scanner</h5>
                                    </div>
                                    <div class="card-body text-center">
                                        <div id="camera-container" style="display: none;">
                                            <video id="camera-feed" width="100%" height="300" style="border: 2px solid #ddd; border-radius: 8px;"></video>
                                            <div class="mt-2">
                                                <button id="stop-camera" class="btn btn-danger btn-sm">
                                                    <i class="fas fa-stop"></i> Stop Camera
                                                </button>
                                            </div>
                                        </div>
                                        <div id="camera-controls">
                                            <button id="start-camera" class="btn btn-success btn-lg">
                                                <i class="fas fa-camera"></i> Start Camera Scanner
                                            </button>
                                            <div class="mt-2">
                                                <small class="text-muted">Position the barcode in front of your camera</small>
                                            </div>
                                        </div>
                                        <div id="camera-error" class="alert alert-warning mt-3" style="display: none;">
                                            <i class="fas fa-exclamation-triangle"></i> Camera access denied or not available. Please use manual input below.
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-keyboard"></i> Manual Input</h5>
                                    </div>
                                    <div class="card-body">
                                        <form method="post" id="barcode-form">
                                            {% csrf_token %}
                                            <div class="mb-3">
                                                <label for="{{ form.barcode.id_for_label }}" class="form-label">Barcode</label>
                                                {{ form.barcode }}
                                                {% if form.barcode.errors %}
                                                    <div class="text-danger small mt-1">
                                                        {{ form.barcode.errors }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <button type="submit" class="btn btn-primary w-100">
                                                <i class="fas fa-search"></i> Search Book
                                            </button>
                                        </form>
                                        
                                        {% if error_message %}
                                            <div class="alert alert-danger mt-3">
                                                <i class="fas fa-exclamation-circle"></i> {{ error_message }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Book Result -->
                        {% if book %}
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0"><i class="fas fa-book"></i> Book Found</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <img src="{{ book.get_cover_image_url }}" 
                                                 class="img-fluid rounded" 
                                                 alt="{{ book.title }} cover"
                                                 style="max-height: 200px; width: 100%; object-fit: cover;"
                                                 onerror="this.src='{% static 'images/default_book_cover.svg' %}'">
                                        </div>
                                        <div class="col-md-9">
                                            <h4>{{ book.title }}</h4>
                                            <p class="text-muted mb-2"><strong>Author:</strong> {{ book.author }}</p>
                                            {% if book.isbn %}
                                                <p class="text-muted mb-2"><strong>ISBN:</strong> {{ book.isbn }}</p>
                                            {% endif %}
                                            <p class="text-muted mb-2"><strong>Barcode:</strong> {{ book.barcode }}</p>
                                            <p class="text-muted mb-3"><strong>Shelf:</strong> {{ book.shelf }}</p>
                                            
                                            <div class="mb-3">
                                                {% if book.is_available %}
                                                    <span class="badge bg-success fs-6">
                                                        <i class="fas fa-check-circle"></i> Available
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-danger fs-6">
                                                        <i class="fas fa-times-circle"></i> Currently Borrowed
                                                    </span>
                                                {% endif %}
                                            </div>
                                            
                                            <div class="btn-group" role="group">
                                                <a href="{% url 'books:book_detail' book.id %}" class="btn btn-outline-primary">
                                                    <i class="fas fa-eye"></i> View Details
                                                </a>
                                                {% if book.is_available %}
                                                    <a href="{% url 'books:quick_borrow' book.id %}" class="btn btn-success">
                                                        <i class="fas fa-book-reader"></i> Quick Borrow
                                                    </a>
                                                {% else %}
                                                    <a href="{% url 'books:reserve_book' book.id %}" class="btn btn-warning">
                                                        <i class="fas fa-bookmark"></i> Reserve
                                                    </a>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                        
                        <!-- Quick Actions -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-bolt"></i> Quick Actions</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <a href="{% url 'books:view_books_list' %}" class="btn btn-outline-primary w-100 mb-2">
                                                    <i class="fas fa-list"></i><br>Browse Books
                                                </a>
                                            </div>
                                            <div class="col-md-3">
                                                <a href="{% url 'books:add_a_book' %}" class="btn btn-outline-success w-100 mb-2">
                                                    <i class="fas fa-plus"></i><br>Add New Book
                                                </a>
                                            </div>
                                            <div class="col-md-3">
                                                <a href="{% url 'books:my_books' %}" class="btn btn-outline-info w-100 mb-2">
                                                    <i class="fas fa-user-books"></i><br>My Books
                                                </a>
                                            </div>
                                            <div class="col-md-3">
                                                <a href="{% url 'books:dashboard' %}" class="btn btn-outline-secondary w-100 mb-2">
                                                    <i class="fas fa-chart-bar"></i><br>Dashboard
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Include QuaggaJS for barcode scanning -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    
    <script>
        let isScanning = false;
        let stream = null;
        
        // Camera controls
        document.getElementById('start-camera').addEventListener('click', startCamera);
        document.getElementById('stop-camera').addEventListener('click', stopCamera);
        
        // Barcode input focus
        document.getElementById('barcode-scan-input').focus();
        
        async function startCamera() {
            try {
                // Request camera access
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment', // Use back camera if available
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    } 
                });
                
                const video = document.getElementById('camera-feed');
                video.srcObject = stream;
                video.play();
                
                // Show camera container and hide controls
                document.getElementById('camera-container').style.display = 'block';
                document.getElementById('camera-controls').style.display = 'none';
                document.getElementById('camera-error').style.display = 'none';
                
                // Initialize QuaggaJS
                initializeQuagga();
                
            } catch (error) {
                console.error('Camera access error:', error);
                document.getElementById('camera-error').style.display = 'block';
            }
        }
        
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            if (isScanning) {
                Quagga.stop();
                isScanning = false;
            }
            
            // Hide camera container and show controls
            document.getElementById('camera-container').style.display = 'none';
            document.getElementById('camera-controls').style.display = 'block';
        }
        
        function initializeQuagga() {
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#camera-feed'),
                    constraints: {
                        width: 640,
                        height: 480,
                        facingMode: "environment"
                    }
                },
                decoder: {
                    readers: [
                        "code_128_reader",
                        "ean_reader",
                        "ean_8_reader",
                        "code_39_reader",
                        "code_39_vin_reader",
                        "codabar_reader",
                        "upc_reader",
                        "upc_e_reader",
                        "i2of5_reader"
                    ]
                },
                locate: true,
                locator: {
                    patchSize: "medium",
                    halfSample: true
                }
            }, function(err) {
                if (err) {
                    console.error('QuaggaJS initialization error:', err);
                    document.getElementById('camera-error').style.display = 'block';
                    return;
                }
                
                console.log("QuaggaJS initialization finished. Ready to start");
                Quagga.start();
                isScanning = true;
            });
            
            // Listen for successful barcode detection
            Quagga.onDetected(function(result) {
                const barcode = result.codeResult.code;
                console.log('Barcode detected:', barcode);
                
                // Fill the input field
                document.getElementById('barcode-scan-input').value = barcode;
                
                // Stop scanning
                stopCamera();
                
                // Submit the form
                document.getElementById('barcode-form').submit();
            });
        }
        
        // Handle manual barcode input
        document.getElementById('barcode-scan-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('barcode-form').submit();
            }
        });
        
        // Auto-focus on barcode input when page loads
        window.addEventListener('load', function() {
            document.getElementById('barcode-scan-input').focus();
        });
        
        // Clean up camera when page is unloaded
        window.addEventListener('beforeunload', function() {
            stopCamera();
        });
    </script>
</body>
{% endblock %}