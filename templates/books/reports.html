{% extends 'library_users/base.html' %}
{% load static %}

{% block title %}Library Reports & Analytics{% endblock %}

{% block extra_css %}
<style>
    .report-section {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 25px;
        margin-bottom: 30px;
    }
    .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        margin-bottom: 20px;
    }
    .metric-number { font-size: 2rem; font-weight: bold; }
    .metric-label { font-size: 0.9rem; opacity: 0.9; }
    .progress-custom {
        height: 25px;
        border-radius: 15px;
    }
    .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(0,0,0,.02);
    }
    .badge-custom {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
    }
    .section-header {
        border-bottom: 3px solid #667eea;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    .export-btn {
        position: absolute;
        top: 15px;
        right: 15px;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>üìä Library Reports & Analytics</h1>
                <div>
                    <button class="btn btn-outline-primary" onclick="printReport()">üñ®Ô∏è Print</button>
                    <button class="btn btn-primary" onclick="exportReport()">üì§ Export PDF</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Overview Statistics -->
    <div class="report-section">
        <h3 class="section-header">üìà Overview Statistics</h3>
        <div class="stats-grid">
            <div class="metric-card">
                <div class="metric-number">{{ book_stats.total_books }}</div>
                <div class="metric-label">Total Books</div>
            </div>
            <div class="metric-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <div class="metric-number">{{ user_stats.active_users }}</div>
                <div class="metric-label">Active Users</div>
            </div>
            <div class="metric-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <div class="metric-number">{{ borrowing_stats.active_borrowings }}</div>
                <div class="metric-label">Active Borrowings</div>
            </div>
            <div class="metric-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                <div class="metric-number">${{ borrowing_stats.total_fines|floatformat:2 }}</div>
                <div class="metric-label">Total Fines</div>
            </div>
        </div>

        <!-- Progress Bars -->
        <div class="row">
            <div class="col-md-6">
                <h6>Book Availability</h6>
                <div class="progress progress-custom mb-3">
                    <div class="progress-bar bg-success" style="width: {{ book_stats.available_books|div:book_stats.total_books|mul:100 }}%">
                        {{ book_stats.available_books }} Available
                    </div>
                    <div class="progress-bar bg-warning" style="width: {{ book_stats.borrowed_books|div:book_stats.total_books|mul:100 }}%">
                        {{ book_stats.borrowed_books }} Borrowed
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <h6>User Engagement</h6>
                <div class="progress progress-custom mb-3">
                    <div class="progress-bar bg-info" style="width: {{ user_stats.users_with_books|div:user_stats.active_users|mul:100 }}%">
                        {{ user_stats.users_with_books }} Currently Borrowing
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Popular Books -->
    <div class="report-section">
        <h3 class="section-header">üèÜ Most Popular Books</h3>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>Rank</th>
                        <th>Title</th>
                        <th>Author</th>
                        <th>ISBN</th>
                        <th>Times Borrowed</th>
                        <th>Availability</th>
                    </tr>
                </thead>
                <tbody>
                    {% for book in popular_books %}
                    <tr>
                        <td><span class="badge bg-primary badge-custom">{{ forloop.counter }}</span></td>
                        <td><a href="{% url 'books:book_detail' book.pk %}">{{ book.title }}</a></td>
                        <td>{{ book.author }}</td>
                        <td>{{ book.isbn|default:"-" }}</td>
                        <td><span class="badge bg-success badge-custom">{{ book.borrow_count }}</span></td>
                        <td>
                            {% if book.is_available %}
                                <span class="badge bg-success">Available</span>
                            {% else %}
                                <span class="badge bg-warning">Borrowed</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="6" class="text-center text-muted">No borrowing data available</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Overdue Books -->
    <div class="report-section">
        <h3 class="section-header">‚ö†Ô∏è Overdue Books Report</h3>
        {% if overdue_books %}
        <div class="alert alert-warning">
            <strong>‚ö†Ô∏è Alert:</strong> There are {{ overdue_books|length }} overdue books requiring immediate attention.
        </div>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead class="table-danger">
                    <tr>
                        <th>Book Title</th>
                        <th>Borrower</th>
                        <th>Contact</th>
                        <th>Due Date</th>
                        <th>Days Overdue</th>
                        <th>Fine Amount</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for borrowing in overdue_books %}
                    <tr>
                        <td><a href="{% url 'books:book_detail' borrowing.book.pk %}">{{ borrowing.book.title }}</a></td>
                        <td>{{ borrowing.borrower.user.get_full_name }}</td>
                        <td>{{ borrowing.borrower.user.email }}</td>
                        <td>{{ borrowing.due_date }}</td>
                        <td><span class="badge bg-danger">{{ borrowing.days_overdue }} days</span></td>
                        <td>${{ borrowing.calculate_fine|floatformat:2 }}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="sendReminder({{ borrowing.id }})">
                                üìß Remind
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-success">
            <strong>üéâ Excellent!</strong> No overdue books at this time.
        </div>
        {% endif %}
    </div>

    <!-- Books Due Soon -->
    <div class="report-section">
        <h3 class="section-header">üìÖ Books Due Soon (Next 3 Days)</h3>
        {% if books_due_soon %}
        <div class="table-responsive">
            <table class="table table-striped">
                <thead class="table-warning">
                    <tr>
                        <th>Book Title</th>
                        <th>Borrower</th>
                        <th>Contact</th>
                        <th>Due Date</th>
                        <th>Days Until Due</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for borrowing in books_due_soon %}
                    <tr>
                        <td><a href="{% url 'books:book_detail' borrowing.book.pk %}">{{ borrowing.book.title }}</a></td>
                        <td>{{ borrowing.borrower.user.get_full_name }}</td>
                        <td>{{ borrowing.borrower.user.email }}</td>
                        <td>{{ borrowing.due_date }}</td>
                        <td><span class="badge bg-warning">{{ borrowing.days_until_due }} days</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-info" onclick="sendReminder({{ borrowing.id }})">
                                üìß Send Reminder
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">
            <strong>‚ÑπÔ∏è Info:</strong> No books are due in the next 3 days.
        </div>
        {% endif %}
    </div>

    <!-- User Statistics -->
    <div class="report-section">
        <h3 class="section-header">üë• User Statistics</h3>
        <div class="row">
            <div class="col-md-6">
                <h5>User Distribution</h5>
                <ul class="list-group">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Active Users
                        <span class="badge bg-success rounded-pill">{{ user_stats.active_users }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Users with Books
                        <span class="badge bg-primary rounded-pill">{{ user_stats.users_with_books }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Users with Fines
                        <span class="badge bg-warning rounded-pill">{{ user_stats.users_with_fines }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Inactive Users
                        <span class="badge bg-secondary rounded-pill">{{ user_stats.inactive_users }}</span>
                    </li>
                </ul>
            </div>
            <div class="col-md-6">
                <h5>Borrowing Statistics</h5>
                <ul class="list-group">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Total Borrowings
                        <span class="badge bg-info rounded-pill">{{ borrowing_stats.total_borrowings }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Currently Borrowed
                        <span class="badge bg-primary rounded-pill">{{ borrowing_stats.active_borrowings }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Average Borrowing Period
                        <span class="badge bg-success rounded-pill">{{ borrowing_stats.avg_borrowing_days }} days</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Books Returned
                        <span class="badge bg-secondary rounded-pill">{{ borrowing_stats.returned_borrowings }}</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Reservation Statistics -->
    <div class="report-section">
        <h3 class="section-header">üìã Reservation Statistics</h3>
        <div class="row">
            <div class="col-md-8">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Count</th>
                                <th>Percentage</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Total Reservations</td>
                                <td>{{ reservation_stats.total_reservations }}</td>
                                <td>100%</td>
                            </tr>
                            <tr>
                                <td>Active Reservations</td>
                                <td>{{ reservation_stats.active_reservations }}</td>
                                <td>{{ reservation_stats.active_reservations|div:reservation_stats.total_reservations|mul:100|floatformat:1 }}%</td>
                            </tr>
                            <tr>
                                <td>Fulfilled Reservations</td>
                                <td>{{ reservation_stats.fulfilled_reservations }}</td>
                                <td>{{ reservation_stats.fulfilled_reservations|div:reservation_stats.total_reservations|mul:100|floatformat:1 }}%</td>
                            </tr>
                            <tr>
                                <td>Expired Reservations</td>
                                <td>{{ reservation_stats.expired_reservations }}</td>
                                <td>{{ reservation_stats.expired_reservations|div:reservation_stats.total_reservations|mul:100|floatformat:1 }}%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="col-md-4">
                <h6>Most Reserved Books</h6>
                <ol class="list-group list-group-numbered">
                    {% for book in reservation_stats.most_reserved_books %}
                    <li class="list-group-item d-flex justify-content-between align-items-start">
                        <div class="ms-2 me-auto">
                            <div class="fw-bold">{{ book.title|truncatechars:25 }}</div>
                            {{ book.author|truncatechars:20 }}
                        </div>
                        <span class="badge bg-primary rounded-pill">{{ book.reservation_count }}</span>
                    </li>
                    {% empty %}
                    <li class="list-group-item">No reservation data available</li>
                    {% endfor %}
                </ol>
            </div>
        </div>
    </div>

    <!-- Report Footer -->
    <div class="report-section">
        <div class="row">
            <div class="col-md-6">
                <p class="text-muted">
                    <small>
                        üìÖ Report generated on: {{ "now"|date:"F d, Y \a\t g:i A" }}<br>
                        üìä Data as of: {{ "now"|date:"F d, Y" }}
                    </small>
                </p>
            </div>
            <div class="col-md-6 text-end">
                <p class="text-muted">
                    <small>
                        üè¢ NTA Library Management System<br>
                        üìß Contact: library@nta.edu
                    </small>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function sendReminder(borrowingId) {
    if (confirm('Send reminder email to borrower?')) {
        // Implementation for sending reminder emails
        fetch(`/api/send-reminder/${borrowingId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Reminder sent successfully!');
            } else {
                alert('Failed to send reminder. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    }
}

function printReport() {
    window.print();
}

function exportReport() {
    // Implementation for PDF export
    window.open('/books/reports/export/pdf/', '_blank');
}

// Print styles
const printStyles = `
    @media print {
        .btn, .export-btn { display: none !important; }
        .report-section { break-inside: avoid; }
        body { font-size: 12px; }
    }
`;
const styleSheet = document.createElement("style");
styleSheet.innerText = printStyles;
document.head.appendChild(styleSheet);
</script>
{% endblock %}